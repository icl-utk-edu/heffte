name: CI

on:
  push:
    branches: [ master , gragghia/ci ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  heffte_gpu:
    strategy:
      matrix:
        maker: [cmake, spack]
        device: [gpu_nvidia]
      fail-fast: false
    runs-on: ${{matrix.device}}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v3
      - name: Build
        run: .github/workflows/build-${{matrix.maker}}.sh build ${{matrix.device}}
      - name: Test
        run: .github/workflows/build-${{matrix.maker}}.sh test ${{matrix.device}}
      - name: SmokeTest
        run: .github/workflows/build-${{matrix.maker}}.sh smoketest ${{matrix.device}}
      - run: find .
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: build-logs ${{matrix.maker}} ${{matrix.device}}
          path: |
                *.txt
                spack-build-*/CMakeFiles/*.log
                build/CMakeFiles/*.log
                .spack/test/*/*.txt
